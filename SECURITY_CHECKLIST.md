# Security Checklist - ImobiBase

## Pre-Deployment Security Checks

Use this checklist before deploying to production or staging environments.

---

## 1. Environment Variables & Secrets

### Critical Checks
- [ ] **All `.env` files removed from git history**
  ```bash
  # Check if .env files are tracked
  git ls-files | grep "\.env"
  # Should return EMPTY (only .env.example is allowed)
  ```

- [ ] **Generate new secrets for production**
  ```bash
  ./scripts/generate-secrets.sh
  ```

- [ ] **Validate SESSION_SECRET is set and strong**
  ```bash
  # Should be at least 32 characters, random
  echo $SESSION_SECRET | wc -c
  # Should output >= 32
  ```

- [ ] **All API keys are production keys (not test/sandbox)**
  - Check STRIPE_SECRET_KEY starts with `sk_live_`
  - Check MERCADOPAGO uses production credentials
  - Check SENDGRID_API_KEY is valid
  - Check GOOGLE_MAPS_API_KEY has restrictions set

- [ ] **Database credentials are secure**
  - [ ] Database password is strong (generated by script)
  - [ ] DATABASE_URL does not contain default/example credentials
  - [ ] Database user has minimal required permissions

- [ ] **Set proper .env file permissions**
  ```bash
  chmod 600 .env
  chmod 600 .env.production
  chmod 600 .env.staging
  ```

### Secret Rotation Schedule
- [ ] SESSION_SECRET - Rotate every 90 days
- [ ] Database passwords - Rotate every 180 days
- [ ] API keys - Review and rotate annually
- [ ] Webhook secrets - Rotate if compromised

---

## 2. Content Security Policy (CSP)

### Verification
- [ ] **CSP is enabled in production**
  ```bash
  # Check routes.ts has nonce-based CSP
  grep -A 20 "contentSecurityPolicy" server/routes.ts | grep "nonce"
  ```

- [ ] **No 'unsafe-inline' or 'unsafe-eval' in scriptSrc**
  ```bash
  # This should return EMPTY or only in styleSrc with nonce
  grep "unsafe-eval" server/routes.ts
  grep "unsafe-inline.*scriptSrc" server/routes.ts
  ```

- [ ] **Test CSP headers in production**
  ```bash
  curl -I https://your-domain.com | grep -i "content-security-policy"
  ```

### Frontend Updates Required
- [ ] Add `nonce` attribute to inline scripts
  ```html
  <!-- In your HTML template -->
  <script nonce="<%= cspNonce %>">
    // inline script
  </script>
  ```

- [ ] Add `nonce` attribute to inline styles
  ```html
  <style nonce="<%= cspNonce %>">
    /* inline styles */
  </style>
  ```

---

## 3. HTTPS & TLS

- [ ] **Force HTTPS in production**
  - HSTS header enabled (check routes.ts)
  - `upgradeInsecureRequests` in CSP enabled

- [ ] **Valid SSL/TLS certificate**
  ```bash
  # Check certificate expiry
  echo | openssl s_client -servername your-domain.com -connect your-domain.com:443 2>/dev/null | openssl x509 -noout -dates
  ```

- [ ] **TLS 1.2 or higher only**
  - Disable TLS 1.0 and 1.1 in your hosting provider

---

## 4. Rate Limiting & DDoS Protection

- [ ] **Rate limiting is enabled**
  ```bash
  # Check routes.ts has rate limiting
  grep -A 5 "rateLimit" server/routes.ts
  ```

- [ ] **Authentication endpoints have strict limits**
  - Login: 5 requests per 15 minutes per IP
  - Password reset: 3 requests per hour per email
  - Registration: 5 requests per hour per IP

- [ ] **Consider Cloudflare or AWS Shield for DDoS**

---

## 5. Authentication & Authorization

- [ ] **Password hashing uses strong algorithm**
  - Check `scrypt` is used (in routes.ts)
  - Salt is unique per password

- [ ] **Session security**
  - [ ] `secure: true` in production (HTTPS only)
  - [ ] `httpOnly: true` (prevent XSS)
  - [ ] `sameSite: 'lax'` or `'strict'`
  - [ ] Session timeout configured (24 hours max)

- [ ] **No sensitive data in JWT payload**
  - No passwords, credit cards, or PII
  - Only user ID and role

- [ ] **RBAC (Role-Based Access Control) enforced**
  - Admin routes check `req.user.role === 'admin'`
  - User can only access their own tenant data

---

## 6. Database Security

- [ ] **SQL injection prevention**
  - All queries use parameterized queries
  - No string concatenation in SQL
  - ORM (Drizzle) used properly

- [ ] **Database connection security**
  - [ ] SSL/TLS enabled for database connections
  - [ ] Database not exposed to public internet
  - [ ] Firewall rules limit access to app servers only

- [ ] **Backup encryption**
  - [ ] Database backups are encrypted at rest
  - [ ] Backup access requires MFA

---

## 7. Input Validation & Sanitization

- [ ] **All user input is validated**
  - Email format validation
  - Phone number validation
  - Date validation
  - File upload validation (type, size, content)

- [ ] **Output encoding**
  - HTML escaped in templates
  - JSON responses properly encoded
  - No `dangerouslySetInnerHTML` without sanitization

- [ ] **File upload security**
  - [ ] Max file size enforced (e.g., 5MB)
  - [ ] File type whitelist (not blacklist)
  - [ ] Files scanned for malware
  - [ ] Files stored outside web root
  - [ ] Unique filenames (prevent overwrite attacks)

---

## 8. Third-Party Dependencies

- [ ] **No known vulnerabilities**
  ```bash
  npm audit --production
  # Should report 0 vulnerabilities
  ```

- [ ] **Dependencies are up to date**
  ```bash
  npm outdated
  ```

- [ ] **Audit critical packages**
  - express
  - helmet
  - passport
  - jsonwebtoken
  - pg (postgres client)

---

## 9. Logging & Monitoring

- [ ] **Security events are logged**
  - Failed login attempts
  - Password resets
  - Role changes
  - Data exports

- [ ] **No sensitive data in logs**
  - No passwords, tokens, or API keys
  - Credit card numbers masked
  - Emails partially masked (u***@example.com)

- [ ] **Log retention policy**
  - Security logs kept for 90 days minimum
  - Application logs kept for 30 days

- [ ] **Error tracking configured**
  - [ ] Sentry DSN configured
  - [ ] Error notifications for critical issues
  - [ ] Stack traces do not expose secrets

---

## 10. API Security

- [ ] **CORS configured properly**
  ```bash
  # Check CORS_ORIGINS in .env
  echo $CORS_ORIGINS
  ```
  - Only allow trusted domains
  - Do NOT use `*` wildcard in production

- [ ] **API versioning**
  - `/api/v1/` prefix for all endpoints
  - Deprecated endpoints return 410 Gone

- [ ] **Request size limits**
  - JSON body limit: 10MB
  - File upload limit: 50MB
  - Query string limit: 1000 characters

---

## 11. Infrastructure Security

- [ ] **Firewall rules configured**
  - Only ports 80 (HTTP), 443 (HTTPS), 22 (SSH) exposed
  - SSH limited to specific IPs or VPN
  - Database port (5432) NOT exposed

- [ ] **SSH key authentication**
  - Password authentication disabled
  - Only authorized keys allowed
  - Key rotation every 6 months

- [ ] **OS and packages updated**
  ```bash
  sudo apt update && sudo apt upgrade -y
  ```

- [ ] **Docker security** (if using Docker)
  - [ ] Run as non-root user
  - [ ] Use official base images
  - [ ] Scan images for vulnerabilities
  - [ ] `.dockerignore` excludes `.env` files

---

## 12. Compliance (LGPD/GDPR)

- [ ] **Privacy policy published**
- [ ] **Terms of service published**
- [ ] **Cookie consent banner implemented**
- [ ] **Data export functionality for users**
- [ ] **Data deletion functionality for users**
- [ ] **Audit trail for data access**

---

## 13. Deployment Verification

### Post-Deployment Tests

1. **Test CSP headers**
   ```bash
   curl -I https://your-domain.com | grep -i "content-security-policy"
   ```

2. **Test HSTS header**
   ```bash
   curl -I https://your-domain.com | grep -i "strict-transport-security"
   ```

3. **Test security headers**
   ```bash
   curl -I https://your-domain.com | grep -i "x-content-type-options"
   curl -I https://your-domain.com | grep -i "x-frame-options"
   ```

4. **Verify HTTPS redirect**
   ```bash
   curl -I http://your-domain.com
   # Should return 301/302 to https://
   ```

5. **Test rate limiting**
   ```bash
   # Make 100+ rapid requests
   for i in {1..100}; do curl -s -o /dev/null -w "%{http_code}\n" https://your-domain.com/api/properties; done
   # Should eventually return 429 (Too Many Requests)
   ```

6. **Run security scan**
   - Use https://observatory.mozilla.org
   - Use https://securityheaders.com
   - Target grade: A or A+

---

## 14. Incident Response Plan

- [ ] **Security contact email configured**
  - security@imobibase.com

- [ ] **Incident response team identified**
  - Primary: [Your Name]
  - Secondary: [Backup Name]

- [ ] **Breach notification plan**
  - Timeline: Notify users within 72 hours
  - Template email prepared
  - Legal counsel on standby

---

## Emergency Actions

### If .env files were committed to git:

```bash
# 1. Remove from current commit
git rm --cached .env .env.production .env.staging

# 2. Add to .gitignore (already done)

# 3. Commit the removal
git commit -m "Remove sensitive .env files from version control"

# 4. Rewrite history (DANGEROUS - coordinate with team)
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch .env .env.* -r" \
  --prune-empty --tag-name-filter cat -- --all

# 5. Force push (DANGEROUS - coordinate with team)
git push origin --force --all

# 6. ROTATE ALL SECRETS IMMEDIATELY
./scripts/generate-secrets.sh

# 7. Update all API keys, database passwords, etc.
```

### If secrets are leaked:

1. **Immediately rotate all secrets**
   - Run `./scripts/generate-secrets.sh`
   - Update production environment variables
   - Restart application servers

2. **Revoke API keys**
   - Stripe dashboard
   - SendGrid dashboard
   - Google Cloud Console
   - Other providers

3. **Monitor for unauthorized access**
   - Check application logs
   - Check database audit logs
   - Check payment gateway logs

4. **Notify affected users if needed**
   - Follow LGPD/GDPR breach notification requirements

---

## Sign-off

Before deploying to production, the following people must verify this checklist:

- [ ] **Developer**: _________________ Date: _______
- [ ] **Security Lead**: _________________ Date: _______
- [ ] **DevOps/SRE**: _________________ Date: _______

---

## References

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [OWASP Cheat Sheet Series](https://cheatsheetseries.owasp.org/)
- [Mozilla Security Guidelines](https://infosec.mozilla.org/guidelines/web_security)
- [CWE Top 25](https://cwe.mitre.org/top25/archive/2023/2023_top25_list.html)
- [LGPD Guidelines](https://www.gov.br/cidadania/pt-br/acesso-a-informacao/lgpd)
